<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oral Bridge OBT</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Serif+4:opsz,wght@8..60,400;8..60,600&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #FAF9F7;
            --bg-secondary: #FFFFFF;
            --bg-tertiary: #F3F1ED;
            --text-primary: #1A1A1A;
            --text-secondary: #5A5A5A;
            --text-muted: #8A8A8A;
            --accent: #B45309;
            --accent-light: #FEF3C7;
            --accent-hover: #92400E;
            --border: #E5E2DC;
            --success: #166534;
            --success-bg: #DCFCE7;
            --agent1: #7C3AED;
            --agent2: #0891B2;
            --agent3: #059669;
            --agent4: #DC2626;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.07), 0 2px 4px -1px rgba(0,0,0,0.04);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.08), 0 4px 6px -2px rgba(0,0,0,0.04);
            --radius: 8px;
            --radius-lg: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: var(--accent);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon svg {
            width: 28px;
            height: 28px;
            fill: white;
        }

        h1 {
            font-family: 'Source Serif 4', serif;
            font-size: 2rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
            margin-top: 0.25rem;
        }

        /* Setup Section */
        .setup-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .setup-row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .input-group {
            flex: 1;
            min-width: 200px;
        }

        .input-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 1rem;
            font-family: inherit;
            background: var(--bg-primary);
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-secondary);
        }

        .help-text {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        /* Progress Steps */
        .progress-steps {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1rem;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-muted);
            transition: all 0.3s ease;
        }

        .step-number {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .step.active {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-light);
        }

        .step.active .step-number {
            background: var(--accent);
            color: white;
        }

        .step.completed {
            border-color: var(--success);
            color: var(--success);
            background: var(--success-bg);
        }

        .step.completed .step-number {
            background: var(--success);
            color: white;
        }

        /* Main Card */
        .main-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            margin-bottom: 1.5rem;
        }

        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .step-badge {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1rem;
            color: white;
        }

        .step-1 .step-badge { background: var(--agent1); }
        .step-2 .step-badge { background: var(--agent2); }
        .step-3 .step-badge { background: var(--agent3); }
        .step-4 .step-badge { background: var(--agent4); }

        .card-title h2 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.125rem;
        }

        .card-title p {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Text Areas */
        .text-box {
            width: 100%;
            min-height: 180px;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-family: inherit;
            font-size: 0.95rem;
            line-height: 1.7;
            resize: vertical;
            background: var(--bg-primary);
        }

        .text-box:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-secondary);
        }

        .text-box.output {
            background: var(--bg-tertiary);
            font-family: 'Source Serif 4', serif;
            font-size: 1.05rem;
        }

        .text-box.json-output {
            font-family: monospace;
            font-size: 0.85rem;
            background: #1a1a1a;
            color: #e0e0e0;
            border: none;
        }

        .text-label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .section-gap {
            margin-top: 1.5rem;
        }

        /* Buttons */
        .btn {
            padding: 0.875rem 1.75rem;
            border: none;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-large {
            padding: 1rem 2rem;
            font-size: 1.1rem;
            border-radius: var(--radius-lg);
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-primary:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #14532d;
        }

        .button-row {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-top: 1.5rem;
        }

        .button-row-center {
            justify-content: center;
        }

        /* Loading State */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            gap: 1rem;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.1rem;
            color: var(--text-secondary);
        }

        /* Messages */
        .message {
            padding: 1rem 1.25rem;
            border-radius: var(--radius);
            margin-bottom: 1rem;
            font-size: 0.95rem;
        }

        .message-error {
            background: #FEF2F2;
            border: 1px solid #FECACA;
            color: #991B1B;
        }

        .message-success {
            background: var(--success-bg);
            border: 1px solid #86EFAC;
            color: var(--success);
        }

        .message-info {
            background: var(--accent-light);
            border: 1px solid #FCD34D;
            color: #92400E;
        }

        /* Start Screen */
        .start-screen {
            text-align: center;
            padding: 3rem 2rem;
        }

        .start-screen h2 {
            font-family: 'Source Serif 4', serif;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .start-screen p {
            color: var(--text-secondary);
            margin-bottom: 2rem;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 1.5rem 0;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .setup-row {
                flex-direction: column;
            }
            
            .input-group {
                width: 100%;
            }

            .step {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
            }

            .step-number {
                width: 20px;
                height: 20px;
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                </div>
                <h1>Oral Bridge OBT</h1>
            </div>
            <p class="subtitle">AI-Assisted Bible Translation</p>
        </header>

        <!-- Setup Section -->
        <div class="setup-section">
            <div class="setup-row">
                <div class="input-group">
                    <label for="apiKey">API Key</label>
                    <input type="password" id="apiKey" placeholder="Enter your Claude API key">
                </div>
                <div class="input-group" style="max-width: 200px;">
                    <label for="modelSelect">AI Model</label>
                    <select id="modelSelect">
                        <option value="claude-opus-4-5-20251101">Claude Opus 4.5</option>
                        <option value="claude-opus-4-1-20250805">Claude Opus 4.1</option>
                        <option value="claude-sonnet-4-5-20250929">Claude Sonnet 4.5</option>
                        <option value="claude-sonnet-4-20250514">Claude Sonnet 4</option>
                    </select>
                </div>
            </div>
            <p class="help-text">Your API key is saved in your browser and kept private.</p>
        </div>

        <!-- Input Section -->
        <div class="setup-section">
            <div class="setup-row">
                <div class="input-group">
                    <label for="biblicalRef">Bible Passage</label>
                    <input type="text" id="biblicalRef" placeholder="Example: Ruth 1:1-5">
                </div>
                <div class="input-group">
                    <label for="targetLang">Target Language</label>
                    <input type="text" id="targetLang" placeholder="Example: Portuguese" value="Portuguese">
                </div>
                <div class="input-group">
                    <label for="targetAudience">Target Audience</label>
                    <input type="text" id="targetAudience" placeholder="Example: Rural Brazil" value="Rural Brazil / Sertanejo">
                </div>
            </div>
            <div class="button-row button-row-center">
                <button class="btn btn-primary btn-large" id="startBtn" onclick="startPipeline()">
                    Start Translation
                </button>
            </div>
        </div>

        <!-- Progress Steps -->
        <div class="progress-steps hidden" id="progressSteps">
            <div class="step" id="step1">
                <span class="step-number">1</span>
                Meaning Map
            </div>
            <div class="step" id="step2">
                <span class="step-number">2</span>
                Discourse
            </div>
            <div class="step" id="step3">
                <span class="step-number">3</span>
                Translation
            </div>
            <div class="step" id="step4">
                <span class="step-number">4</span>
                Review
            </div>
        </div>

        <!-- Main Work Area -->
        <div class="main-card hidden" id="workArea">
            <!-- Content will be dynamically inserted here -->
        </div>

        <footer>
            Oral Bridge OBT • Ready Vessels Project
        </footer>
    </div>

    <script>
        // Agent System Prompts
        const AGENT_PROMPTS = {
            1: `ROLE
You are the Event Architect (Agent 1) in the Tripod pipeline.

MISSION
Convert the user-provided input text into a structured Meaning Map JSON by:
1) registering Frames (scene-setting time/place headers),
2) registering Participants (entities),
3) decomposing the text into atomic Event Cores + role bindings,
4) encoding nuance via Modifiers and Bundles,
while preventing translationese, lexical bias, and hallucinated additions.

CORE PRINCIPLE (Distributed Semantics)
- Do NOT write a translation.
- Use a SMALL closed set of Event Cores (primitives) + roles + modifiers/bundles.
- When the source is underspecified, keep it underspecified (do not guess).

INPUT CONTRACT (User always provides the text)
1) Biblical pericope input:
- The input contains an explicit biblical reference (e.g., "Ruth 1:1–7") AND the passage text.
- Map ONLY from the passage text the user provided (sealed environment).
- DO NOT fetch, reconstruct, "fill in," or harmonize text from memory/training.
- Preferred: original biblical languages (hbo/arc/grc).
If a biblical reference is present BUT the provided text is not in Hebrew/Aramaic/Greek:
- Still map from the provided text (do not reject),
- Add quality flag: "BIBLICAL_REF_BUT_TEXT_NOT_ORIGINAL_LANGUAGE".

2) Non-biblical input:
- The input has NO biblical reference.
- Map from the provided text in its own language as-is.

LANGUAGE DETECTION
- Detect script(s) from the PROVIDED text only.
- Set meta.source_lang to:
  - "hbo" if Hebrew script dominates,
  - "grc" if Greek script dominates,
  - "arc" only if the user labels it Aramaic OR the text is clearly Aramaic,
  - otherwise best-effort BCP47 tag or "und".

SEALED-SYSTEM RULE (No Addition / No Subtraction)
- The input text is the only evidence.
- No external backstory, theology, smoothing, or "what the verse usually says".
- No omission: every semantic unit must be represented (participants, predicates, quantifiers, negations, purpose infinitives, causal markers like כי, etc.).

EVIDENCE / ANCHORING RULE
- Every Participant and every Event MUST include ≥1 anchor.
- Anchors MUST quote exact surface form from the user's provided text.
- If the input includes verse markers (digits, Hebrew letters א ב ג..., etc.), you may omit the marker from the anchor "form" but MUST capture verse reference in "ref" when possible.

OUTPUT FORMAT
- Return JSON only. No commentary. No markdown.

I. TOP-LEVEL JSON STRUCTURE (v3.5.1)
{
  "meta": {
    "protocol": "Tripod v3.5.1",
    "agent": "Event Architect",
    "input_type": "biblical|non_biblical",
    "text_ref": "string|null",
    "source_lang": "hbo|arc|grc|...|und",
    "detected_scripts": ["Hebrew","Greek","Latin","..."],
    "quality_flags": [],
    "status": "OK|OK_WITH_FLAGS"
  },
  "frames": [],
  "participants": [],
  "events": []
}

II. FRAMES (Time/Place/Setting headers)
Frame schema:
{
  "id": "f_*",
  "frame_type": "time|place|setting|discourse",
  "value": "FRAME:*",
  "anchors": [ { "lang": "...", "form": "...", "ref": "..." } ]
}

III. PARTICIPANTS (Entities / Nouns)
Allowed participant types (closed): person, group, divine, item, substance, location, abstract

Participant schema:
{
  "id": "p_*|g_*|loc_*|it_*|abs_*|sub_*",
  "type": "person|group|divine|item|substance|location|abstract",
  "value": "ONT:*",
  "quantity": "1|2|3|few|many|all|mass",
  "is_body_part": true|false,
  "implicit": true|false,
  "member_of": "g_*|null",
  "members": ["p_*", "..."],
  "anchors": [ { "lang": "...", "form": "...", "ref": "..." } ]
}

IV. EVENTS (Predicates)
Event schema:
{
  "id": "e*",
  "category": "STATE|PHYSICAL|INTERNAL|SPEECH",
  "event_core": "exist|be_located|remain|connect|move|enter|exit|return|approach|flee|ascend|descend|do|make|destroy|impact|take|give|receive|send|bring|lose|find|die|rise|perceive_see|perceive_hear|know|think|decide|remember|feel|want|say|ask|command",
  "roles": { },
  "modifiers": { },
  "bundles": { },
  "link_hints": { },
  "anchors": [ { "lang": "...", "form": "...", "ref": "..." } ]
}

A) CLOSED ROLE KEYS: initiator, affected, experiencer, recipient, addressee, content (string), content_ref (event id), source, goal, location, time, instrument, accompaniment, beneficiary

B) ROLE CONSTRAINTS:
- die: the entity who dies MUST be in "affected" (not initiator).
- perceive_hear / perceive_see / know / think (when complement exists): represent the complement as content_ref to another event.
- move/enter/exit/return: use source/goal/location when the text provides them.

C) MODIFIERS (closed values):
{
  "polarity": "positive|negative",
  "reality": "actual|potential|hypothetical|counterfactual",
  "time_frame": "retrospective|immediate|prospective|gnomic",
  "volition": "willful|automatic|unspecified",
  "intensity": "low|medium|high|extreme|unspecified",
  "duration": "string",
  "frequency": "string",
  "approx": true|false
}

D) BUNDLES (nuance without lexical bundling):
"bundles": {
  "state_bundle": {
    "domain": "internal|social|mixed",
    "affect_valence": "positive|negative|mixed|underspecified",
    "tension_status": "resolved|unresolved|underspecified",
    "intensity": "low|medium|high|extreme|underspecified"
  },
  "social_bundle": {
    "relation": "optional_string",
    "notes": "optional_string"
  }
}

E) LINK_HINTS (minimal explicit subordination):
{
  "subordinate_type": "purpose|reason|result|condition|simultaneous|manner|temporal",
  "matrix_event_id": "e*",
  "subordinate_event_id": "e*"
}

V. REQUIRED COVERAGE RULES (No omission)
- Appositions and identity/membership descriptors as connect events with connection_type=membership/origin
- Relational nouns/inalienable relations explicitly stated (wife, sons, daughters-in-law): encode as connect events

VI. PRE-OUTPUT AUDIT
Before outputting JSON, verify:
1) Coverage: every predicate/semantic unit in the input is represented
2) Anchors: every participant and event has ≥1 anchor from PROVIDED text
3) Closed sets: category, event_core, roles, modifiers adhere to allowed lists
4) die uses affected; hear/know with complements use content_ref
5) mass quantity only for substances
6) No external knowledge added

OUTPUT: Return only the JSON object. No explanations.`,

            2: `Role:
You are the Discourse Weaver (Agent 2) in the Tripod Meaning Maps pipeline.

Mission:
You receive a Meaning Map JSON produced by the Event Architect (Agent 1).
Your task is to add discourse structure (global metadata + inter-event relations + discourse functions) WITHOUT changing the meaning decomposition already encoded.

Core Commitments:
- Preserve underspecification.
- Preserve delayed resolution.
- Encode discourse structure WITHOUT adding interpretation.
- Sealed-system: treat the input JSON as the complete data environment.

INPUT CONTRACT (CRITICAL)
You receive ONE JSON object with: meta, frames, participants, events

Agent 1 has already:
- registered participants/frames
- decomposed events into event_core + roles + modifiers (+ optional bundles)
- anchored every participant/event to surface forms

You MUST NOT:
- add new participants
- add new events
- delete anything
- change event_core, roles, modifiers, bundles, anchors
- "repair" semantic analysis (that is Agent 1's job)

You MAY ONLY:
- add discourse-level fields to meta
- add discourse annotation fields to events (and optionally frames)
- add quality flags (append-only)

OUTPUT RULES
- Output JSON only. No commentary. No explanations.
- Return the same JSON object, merged with your additions.
- Do not rename or remove existing fields.

GLOBAL DISCOURSE METADATA (Root meta additions)
Add these fields under meta:
- meta.functional_genre: "narrative" | "procedural" | "hortatory" | "explanatory"
- meta.literary_form: "prose" | "poetry" | "song" | "list" | "epistle" | "prophecy"
- meta.social_register: "intimate" | "casual" | "consultative" | "formal" | "frozen"
- meta.thematic_spine: A single sentence summary of core meaning. DESCRIPTIVE, not interpretive.
- meta.peak_event_id: Must be an existing event id. If unclear, set to null AND add quality flag.
- meta.focal_participants: Array of participant ids that are discourse-central.

Provenance:
- Add meta.agent2 = "Discourse Weaver"
- If meta.agents exists, append "Discourse Weaver"; else add meta.agents = ["Event Architect","Discourse Weaver"]

DISCOURSE FUNCTIONS (Event-level information structure)
For EACH event, add:
- event.discourse_function: "SET" | "BG" | "MAIN" | "EVAL" | "QUOTE_MARGIN"
- event.peak: true|false

DISCOURSE RELATIONS (Inter-event links)
For EACH event with index > 0, add:
event.discourse_logic: {
  "relation_type": "sequence" | "simultaneous" | "cause" | "result" | "purpose" | "condition" | "contrast" | "concession" | "elaboration" | "evidence" | "restatement",
  "relative_to_event_id": "e*",
  "relation_license": "explicit" | "constructional" | "genre_conventional" | "inferred_possible"
}

Relation licensing:
A) explicit - Overt connective/discourse marker is present
B) constructional - Subordination encoded by construction
C) genre_conventional - Default narrative chaining
D) inferred_possible - Only when plausible but NOT clearly signaled (use sparingly)

PARTICIPANT TRACKING
For EACH event, add:
event.same_subject: true|false

AGENT 2 FINAL CHECK
Before outputting JSON, verify:
1) I did not change participants/frames/events semantics from Agent 1.
2) Every event (index > 0) has a discourse_logic relation to a prior event.
3) Every discourse relation has a relation_license.
4) I did NOT upgrade purpose/cause/result without explicit or constructional licensing.
5) peak_event_id points to an existing event id.
6) Output JSON only.`,

            3: `Agent Name: Tripod Studio
Role: The Oral Storyteller (The Elder)
Input: JSON Meaning Map (Tripod Protocol v3.5.1) — Produced by The Discourse Weaver.
Output: PURE NARRATIVE TEXT ONLY (Target Language).

1. THE "LEGACY BAN" (Strict Naming & Knowledge Protocol)
Theological Amnesia: You possess NO external knowledge of biblical history, theology, or tradition. You do not know who "Moses," "Jesus," or "David" are. You strictly recognize only the participants list provided in the JSON.

The Phonological Engine (Proper Names):
Transliterate, Do Not Translate: Map the sounds of the surface_form or gloss into the Target Language's phonology.
Bad (Translation): Beit_Lechem → "Bethlehem" / "House of Bread".
Good (Transliteration - Portuguese): Beit_Lechem → "Bete-Lequem".
Good (Transliteration - English): Yehoshua → "Yeh-hosh-ua".
Foreignness: If a name sounds foreign, preserve that quality. Do not domesticate it.

2. THE SEMANTIC RENDERING (Distributed Semantics)
Atomic Fidelity: You are receiving a map of atomic meanings (Event Cores), not "words."
Rule: Do NOT "re-bundle" or "upgrade" simple concepts into high-register religious terms unless explicitly triggered by modifiers.
Example: If event_core: "speak" + topic: "God", say "He spoke about God." DO NOT say "He preached."
Example: If event_core: "immersed" + liquid: "water", say "He dipped him in water." DO NOT say "He baptized."
Modifiers as Adverbs/Adjectives: Render modifiers explicitly in the narrative flow.

3. THE DISCOURSE ENGINE (Logic & Flow)
You must strictly adhere to the discourse_layer field for every event.
Logic Mapping (Connectors):
- "sequential" / "temporal_sequence" → "Then...", "After that..."
- "simultaneous" → "While...", "At the same time..."
- "result" / "inference" → "So...", "Because of that..."
- "purpose" → "In order to...", "Para..."
- "concession" → "Even though...", "But..."
- "elaboration" → "That is...", "Meaning..."

Function Handling:
- "BG" (Background) → Use background tenses (Imperfect, Past Continuous). Lower the narrative urgency.
- "MAIN" (Main Line) → Use primary narrative tenses (Simple Past, Preterite).
- "SET" (Setting) → Establish time/place clearly at the start.
- "QUOTE_MARGIN" → Speech frame. Connect it naturally to the content of the speech.

Peak & Tone:
Check global_metadata.peak_event_id. When you reach this event ID, slow down the pacing or increase intensity to mark the climax.

4. THE "NO ORPHAN" PROTOCOL (Mandatory Casting)
Rule of Inclusion: Every participant defined in the JSON participants list MUST appear in the narrative text at least once.

5. THE ARCHIVE PROTOCOL (Grammar & Syntax)
- syntax_lock: Do NOT mirror the syntactic structure of the JSON.
- connector_check: Do not use default connectors. Use natural discourse markers.
- voice_restriction: Prefer Active Voice.

6. THE LOGIC OF ORALITY (Style & Syntax)
The Campfire Test: The output must sound like a spoken story told by an elder, not a written text.
Parataxis: Use additive connectors typical of the oral dialect. Avoid complex subordination unless the logic field demands it.
Repetition: Repeat names for clarity rather than relying on long chains of ambiguous pronouns.

7. MANDATORY OUTPUT FORMAT (Strict Constraints)
Content: Output ONLY the narrative story in the Target Language.
Prohibited Elements:
- NO JSON artifacts.
- NO Meta-data or introductory text (e.g., "Here is the story...").
- NO Explanations, footnotes, or translator notes.
- NO Markdown headers (# Title).

Execution: Read the JSON. Translate the Meaning Map into Oral Narrative. Stop.`,

            4: `Role:
You are an expert Bible Translation Consultant specializing in Oral Bible Translation (OBT). You possess deep proficiency in Biblical Hebrew (Masoretic Text) and Biblical Greek (Nestle-Aland), as well as principles of missiology, linguistics, and oral storytelling traditions.

Objective:
Your task is to review a translated passage generated by the "Tripod Studio Agent." You must evaluate this draft against the original biblical text to ensure accuracy, theological integrity, and stylistic naturalness for a specific target audience.

Your Mindset:
You are a partner to the human reviewer. Do not issue final verdicts (e.g., "This is wrong"). Instead, provide observations, risk assessments, and constructive recommendations. You value Dynamic Equivalence (meaning-based translation) over Formal Equivalence (word-for-word), provided the original intent is preserved.

Analysis Protocol
When you receive a draft, perform the following three-step analysis:

1. Exegetical & Theological Check (The Source)
- Compare: Check the draft against the original Hebrew/Greek text.
- Intent: Does the draft convey the communicative intent of the original author?
- Key Terms: Are major theological terms (Sin, Covenant, Redemption, Grace, YHWH) handled correctly?
- Note: In OBT, complex terms often require descriptive phrases. Ensure these descriptions are accurate.
- Additions/Omissions:
  - Flag any unwarranted additions (ideas not present or implied in the text).
  - Flag any harmful omissions (dropping details that alter the plot or theology).
  - Exception: Do not flag "Implicit Information made Explicit" as an error, as this is necessary for OBT.

2. Cultural & Stylistic Check (The Audience)
- Register: Does the language fit the requested persona?
- Orality: Is the text "ear-friendly"?
  - Look for visual markers that need to be audible.
  - Check for connectives that help flow.
- Idioms: Are idioms natural?

3. Output Generation (The Report)
Organize your response into the following markdown structure:

A. Executive Summary
A 2-3 sentence overview of the draft's quality.

B. Exegetical & Theological Analysis
Use a list format to highlight specific issues.
- Verse/Segment: [Reference]
- Hebrew/Greek Concept: [Original Term/Meaning]
- Draft Rendering: [What the agent wrote]
- Analysis: Explain the gap between the two. Is it a loss of meaning? A theological risk?
- Recommendation: Suggest a fix or a question for the human reviewer to consider.

C. Style & Naturalness Notes
- Praise: Point out excellent cultural adaptations.
- Critique: Point out clunky phrasing, transliteration errors, or "Translationese."

D. Suggested Revision
Provide a rewritten version of the segment that incorporates your recommendations while maintaining the intended style/dialect.

Important Constraints
- Do not be pedantic. If a change is minor and doesn't affect meaning, let it slide.
- Transliteration Warning: Be hyper-vigilant about Hebrew/Greek words being transliterated instead of translated.
- Divine Names: Pay attention to how God is addressed. Ensure it aligns with the target audience's religious context.`
        };

        const STEP_TITLES = {
            1: { title: 'Creating Meaning Map', desc: 'Analyzing the biblical text structure' },
            2: { title: 'Adding Discourse', desc: 'Building narrative connections' },
            3: { title: 'Generating Translation', desc: 'Creating the oral translation' },
            4: { title: 'Quality Review', desc: 'Checking accuracy and naturalness' }
        };

        // State
        let currentStep = 0;
        const outputs = { 1: '', 2: '', 3: '', 4: '' };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const savedKey = localStorage.getItem('claudeApiKey');
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
            }

            const savedModel = localStorage.getItem('claudeModel');
            if (savedModel) {
                document.getElementById('modelSelect').value = savedModel;
            }

            document.getElementById('apiKey').addEventListener('change', (e) => {
                localStorage.setItem('claudeApiKey', e.target.value);
            });

            document.getElementById('modelSelect').addEventListener('change', (e) => {
                localStorage.setItem('claudeModel', e.target.value);
            });
        });

        function updateProgress(step) {
            for (let i = 1; i <= 4; i++) {
                const el = document.getElementById(`step${i}`);
                el.classList.remove('active', 'completed');
                if (i < step) {
                    el.classList.add('completed');
                } else if (i === step) {
                    el.classList.add('active');
                }
            }
        }

        function startPipeline() {
            const apiKey = document.getElementById('apiKey').value;
            const biblicalRef = document.getElementById('biblicalRef').value;

            if (!apiKey) {
                alert('Please enter your API key');
                return;
            }

            if (!biblicalRef) {
                alert('Please enter a Bible passage');
                return;
            }

            // Reset
            for (let i = 1; i <= 4; i++) {
                outputs[i] = '';
            }

            currentStep = 1;
            document.getElementById('progressSteps').classList.remove('hidden');
            updateProgress(1);

            // Show step 1
            showStep(1);
        }

        function showStep(step) {
            const workArea = document.getElementById('workArea');
            workArea.classList.remove('hidden');

            const biblicalRef = document.getElementById('biblicalRef').value;
            const targetLang = document.getElementById('targetLang').value;
            const targetAudience = document.getElementById('targetAudience').value;

            let content = '';

            if (step === 1) {
                content = `
                    <div class="card-header step-1">
                        <div class="step-badge">1</div>
                        <div class="card-title">
                            <h2>Create Meaning Map</h2>
                            <p>The AI will analyze the biblical text and create a structured meaning map</p>
                        </div>
                    </div>
                    <div class="card-body">
                        <label class="text-label">Bible Passage: <strong>${biblicalRef}</strong></label>
                        <div class="button-row">
                            <button class="btn btn-primary btn-large" onclick="runStep(1)">
                                Create Meaning Map
                            </button>
                        </div>
                        <div id="output1" class="section-gap"></div>
                    </div>
                `;
            } else if (step === 2) {
                content = `
                    <div class="card-header step-2">
                        <div class="step-badge">2</div>
                        <div class="card-title">
                            <h2>Add Discourse Structure</h2>
                            <p>The AI will add narrative flow and connections to the meaning map</p>
                        </div>
                    </div>
                    <div class="card-body">
                        <label class="text-label">Meaning Map from Step 1</label>
                        <textarea class="text-box json-output" id="input2" rows="8">${outputs[1]}</textarea>
                        <div class="button-row">
                            <button class="btn btn-primary btn-large" onclick="runStep(2)">
                                Add Discourse
                            </button>
                        </div>
                        <div id="output2" class="section-gap"></div>
                    </div>
                `;
            } else if (step === 3) {
                content = `
                    <div class="card-header step-3">
                        <div class="step-badge">3</div>
                        <div class="card-title">
                            <h2>Generate Translation</h2>
                            <p>The AI will create an oral translation in ${targetLang} for ${targetAudience}</p>
                        </div>
                    </div>
                    <div class="card-body">
                        <label class="text-label">Complete Meaning Map from Step 2</label>
                        <textarea class="text-box json-output" id="input3" rows="6">${outputs[2]}</textarea>
                        <div class="button-row">
                            <button class="btn btn-primary btn-large" onclick="runStep(3)">
                                Generate Translation
                            </button>
                        </div>
                        <div id="output3" class="section-gap"></div>
                    </div>
                `;
            } else if (step === 4) {
                content = `
                    <div class="card-header step-4">
                        <div class="step-badge">4</div>
                        <div class="card-title">
                            <h2>Quality Review</h2>
                            <p>The AI will check accuracy and suggest improvements</p>
                        </div>
                    </div>
                    <div class="card-body">
                        <label class="text-label">Translation from Step 3</label>
                        <textarea class="text-box output" id="input4" rows="6">${outputs[3]}</textarea>
                        <div class="button-row">
                            <button class="btn btn-primary btn-large" onclick="runStep(4)">
                                Review Translation
                            </button>
                        </div>
                        <div id="output4" class="section-gap"></div>
                    </div>
                `;
            }

            workArea.innerHTML = content;
        }

        async function runStep(step) {
            const apiKey = document.getElementById('apiKey').value;
            const model = document.getElementById('modelSelect').value;
            const biblicalRef = document.getElementById('biblicalRef').value;
            const targetLang = document.getElementById('targetLang').value;
            const targetAudience = document.getElementById('targetAudience').value;

            const outputDiv = document.getElementById(`output${step}`);
            
            // Show loading
            outputDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <div class="loading-text">${STEP_TITLES[step].title}...</div>
                </div>
            `;

            // Build the user message
            let userMessage = '';
            if (step === 1) {
                userMessage = `Biblical Reference: ${biblicalRef}

Please retrieve the Hebrew/Greek text for this passage and create the Meaning Map JSON following the protocol.`;
            } else if (step === 2) {
                const input = document.getElementById('input2').value;
                userMessage = input;
            } else if (step === 3) {
                const input = document.getElementById('input3').value;
                userMessage = `Target Language: ${targetLang}
Target Audience: ${targetAudience}

${input}`;
            } else if (step === 4) {
                const input = document.getElementById('input4').value;
                userMessage = `Pericope: ${biblicalRef}
Target Language: ${targetLang}
Target Audience: ${targetAudience}

Draft Translation:
${input}`;
            }

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: model,
                        max_tokens: 8192,
                        system: AGENT_PROMPTS[step],
                        messages: [
                            { role: 'user', content: userMessage }
                        ]
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'Request failed');
                }

                const data = await response.json();
                const output = data.content?.[0]?.text || 'No output generated';

                outputs[step] = output;
                currentStep = step;
                updateProgress(step + 1);

                // Show output
                const isJson = step <= 2;
                const outputClass = isJson ? 'json-output' : 'output';
                
                outputDiv.innerHTML = `
                    <div class="message message-success">✓ Step ${step} completed successfully</div>
                    <label class="text-label">Result:</label>
                    <textarea class="text-box ${outputClass}" rows="10" readonly>${output}</textarea>
                    <div class="button-row">
                        <button class="btn btn-secondary" onclick="copyText('${step}')">Copy</button>
                        ${step < 4 ? `<button class="btn btn-success btn-large" onclick="goToStep(${step + 1})">Continue to Step ${step + 1}</button>` : `<button class="btn btn-success btn-large" onclick="startOver()">Start New Translation</button>`}
                    </div>
                `;

            } catch (error) {
                console.error('API Error:', error);
                let errorMsg = error.message;
                
                outputDiv.innerHTML = `
                    <div class="message message-error">
                        <strong>Something went wrong</strong><br><br>
                        ${errorMsg}<br><br>
                        <strong>What to try:</strong><br>
                        • Check your API key is correct<br>
                        • Try a different model from the dropdown<br>
                        • Make sure you have credits in your Anthropic account
                    </div>
                    <div class="button-row">
                        <button class="btn btn-primary" onclick="runStep(${step})">Try Again</button>
                    </div>
                `;
            }
        }

        function goToStep(step) {
            currentStep = step;
            updateProgress(step);
            showStep(step);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function copyText(step) {
            const text = outputs[step];
            navigator.clipboard.writeText(text).then(() => {
                alert('Copied!');
            });
        }

        function startOver() {
            currentStep = 0;
            for (let i = 1; i <= 4; i++) {
                outputs[i] = '';
            }
            document.getElementById('progressSteps').classList.add('hidden');
            document.getElementById('workArea').classList.add('hidden');
            document.getElementById('biblicalRef').value = '';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>
</html>
