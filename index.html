<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oral Bridge - Hindi Team</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Serif+4:opsz,wght@8..60,400;8..60,600&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root{--bg-primary:#FAF9F7;--bg-secondary:#FFFFFF;--bg-tertiary:#F3F1ED;--text-primary:#1A1A1A;--text-secondary:#5A5A5A;--text-muted:#8A8A8A;--accent:#B45309;--accent-light:#FEF3C7;--accent-hover:#92400E;--border:#E5E2DC;--success:#166534;--success-bg:#DCFCE7;--agent1:#7C3AED;--agent2:#0891B2;--agent3:#059669;--agent4:#6B21A8;--validator-primary:#319795;--validator-bg:#E6FFFA;--validator-border:#81E6D9;--shadow-sm:0 1px 2px rgba(0,0,0,0.05);--shadow-md:0 4px 6px -1px rgba(0,0,0,0.07),0 2px 4px -1px rgba(0,0,0,0.04);--shadow-lg:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05);--radius:8px;--radius-lg:12px}
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:'DM Sans',sans-serif;background:var(--bg-primary);color:var(--text-primary);line-height:1.6;min-height:100vh}.container{max-width:1000px;margin:0 auto;padding:2rem}header{text-align:center;margin-bottom:2rem;padding-bottom:1.5rem;border-bottom:1px solid var(--border)}.logo{display:flex;align-items:center;justify-content:center;gap:0.75rem;margin-bottom:0.5rem}.logo-icon{width:48px;height:48px;background:var(--accent);border-radius:12px;display:flex;align-items:center;justify-content:center}.logo-icon svg{width:28px;height:28px;fill:white}h1{font-family:'Source Serif 4',serif;font-size:2rem;font-weight:600}.subtitle{color:var(--text-secondary);font-size:1rem;margin-top:0.25rem}
        .setup-section{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-lg);padding:1.5rem;margin-bottom:1.5rem;box-shadow:var(--shadow-sm)}.setup-row{display:flex;gap:1rem;flex-wrap:wrap;align-items:flex-end}.input-group{flex:1;min-width:180px}.input-group label{display:block;font-weight:500;margin-bottom:0.5rem;font-size:0.95rem}.input-group input,.input-group select{width:100%;padding:0.75rem 1rem;border:1px solid var(--border);border-radius:var(--radius);font-size:1rem;font-family:inherit;background:var(--bg-primary)}.input-group input:focus,.input-group select:focus{outline:none;border-color:var(--accent);background:var(--bg-secondary)}
        .progress-steps{display:flex;justify-content:center;gap:0.5rem;margin-bottom:2rem;flex-wrap:wrap}.step{display:flex;align-items:center;gap:0.5rem;padding:0.5rem 0.875rem;background:var(--bg-secondary);border:2px solid var(--border);border-radius:25px;font-size:0.85rem;font-weight:500;color:var(--text-muted);transition:all 0.3s ease;cursor:pointer}.step:hover{background:var(--bg-tertiary)}.step-number{width:22px;height:22px;border-radius:50%;background:var(--border);display:flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:600}.step.active{border-color:var(--accent);color:var(--accent);background:var(--accent-light)}.step.active .step-number{background:var(--accent);color:white}.step.completed{border-color:var(--success);color:var(--success);background:var(--success-bg)}.step.completed .step-number{background:var(--success);color:white}
        .main-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-lg);overflow:hidden;box-shadow:var(--shadow-md);margin-bottom:1.5rem}.card-header{padding:1.25rem 1.5rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:0.75rem}.step-badge{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:1rem;color:white}.step-1 .step-badge{background:var(--agent1)}.step-2 .step-badge{background:var(--agent2)}.step-3 .step-badge{background:var(--agent3)}.step-4 .step-badge{background:var(--agent4)}.card-title h2{font-size:1.1rem;font-weight:600;margin-bottom:0.125rem}.card-title p{font-size:0.9rem;color:var(--text-secondary)}.card-body{padding:1.5rem}
        .text-box{width:100%;min-height:150px;padding:1rem;border:1px solid var(--border);border-radius:var(--radius);font-family:inherit;font-size:0.95rem;line-height:1.7;resize:vertical;background:var(--bg-primary)}.text-box:focus{outline:none;border-color:var(--accent);background:var(--bg-secondary)}.text-box.output{background:var(--bg-tertiary);font-family:'Source Serif 4',serif;font-size:1.05rem}.text-box.json-output{font-family:monospace;font-size:0.85rem;background:#1a1a1a;color:#e0e0e0;border:none}.text-box.editable{background:var(--bg-secondary);border:2px solid var(--accent)}.text-label{display:block;font-weight:500;margin-bottom:0.5rem;font-size:0.95rem}
        .btn{padding:0.75rem 1.5rem;border:none;border-radius:var(--radius);font-size:1rem;font-weight:500;cursor:pointer;transition:all 0.2s ease;font-family:inherit;display:inline-flex;align-items:center;justify-content:center;gap:0.5rem}.btn-large{padding:1rem 2rem;font-size:1.1rem;border-radius:var(--radius-lg)}.btn-primary{background:var(--accent);color:white}.btn-primary:hover{background:var(--accent-hover);transform:translateY(-1px);box-shadow:var(--shadow-md)}.btn-secondary{background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border)}.btn-secondary:hover{background:var(--border)}.btn-success{background:var(--success);color:white}.btn-success:hover{background:#14532d}.btn-small{padding:0.5rem 1rem;font-size:0.85rem}.button-row{display:flex;gap:0.75rem;flex-wrap:wrap;margin-top:1.5rem}.button-row-center{justify-content:center}
        .loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:3rem;gap:1rem}.spinner{width:48px;height:48px;border:4px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}.loading-text{font-size:1.1rem;color:var(--text-secondary)}.message{padding:1rem 1.25rem;border-radius:var(--radius);margin-bottom:1rem;font-size:0.95rem}.message-error{background:#FEF2F2;border:1px solid #FECACA;color:#991B1B}.message-success{background:var(--success-bg);border:1px solid #86EFAC;color:var(--success)}.message-info{background:#EBF8FF;border:1px solid #90CDF4;color:#2B6CB0}.hidden{display:none !important}footer{text-align:center;padding:1.5rem 0;color:var(--text-muted);font-size:0.85rem}
        .validator-audio-panel{background:var(--validator-bg);border:2px solid var(--validator-border);border-radius:var(--radius-lg);padding:2rem;text-align:center}.main-play-btn{width:120px;height:120px;border-radius:50%;background:linear-gradient(135deg,var(--validator-primary),#285e61);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;margin:2rem auto;box-shadow:var(--shadow-lg);transition:all 0.3s ease}.main-play-btn:hover{transform:scale(1.05);box-shadow:0 15px 30px rgba(49,151,149,0.4)}.main-play-btn:active{transform:scale(0.98)}.main-play-btn svg{width:50px;height:50px;fill:white}.main-play-btn.playing{background:linear-gradient(135deg,#e53e3e,#c53030)}
        .segment-nav{display:flex;height:60px;border-radius:var(--radius-lg);overflow:hidden;margin:1.5rem 0;border:2px solid var(--validator-border);background:white}.segment-block{cursor:pointer;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:1.2rem;transition:all 0.2s;position:relative}.segment-block:hover{filter:brightness(0.92)}.segment-block.playing::after{content:'';position:absolute;bottom:4px;left:50%;transform:translateX(-50%);width:8px;height:8px;background:currentColor;border-radius:50%;animation:pulse 1s ease-in-out infinite}@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
        .audio-progress{height:10px;background:#b2f5ea;border-radius:5px;cursor:pointer;margin:1rem 0;overflow:hidden}.audio-progress-fill{height:100%;background:var(--validator-primary);border-radius:5px;width:0%;transition:width 0.1s}
        .status-indicator{font-size:1.1rem;font-weight:600;margin:1rem 0;min-height:2rem}.time-display{font-family:'DM Sans',monospace;font-size:2rem;font-weight:600;color:var(--validator-primary);margin:1rem 0}
        .analysis-section{background:#F0FFF4;border:2px solid #9AE6B4;border-radius:var(--radius-lg);padding:1.5rem;margin:1.5rem 0}.analysis-item{background:white;border:1px solid #C6F6D5;border-radius:var(--radius);padding:1rem;margin:0.75rem 0}.analysis-item.warning{background:#FFFBEB;border-color:#FCD34D}.analysis-item.issue{background:#FEF2F2;border-color:#FECACA}.analysis-score{display:inline-block;padding:0.25rem 0.75rem;border-radius:20px;font-weight:600;font-size:0.85rem;margin-right:0.5rem}.score-good{background:#C6F6D5;color:#166534}.score-ok{background:#FEF3C7;color:#92400E}.score-low{background:#FECACA;color:#991B1B}
        .edit-section{background:var(--accent-light);border:2px solid var(--accent);border-radius:var(--radius-lg);padding:1.5rem;margin-top:1.5rem}
        .edit-history{background:#f7fafc;border:1px solid var(--border);border-radius:var(--radius);padding:1rem;max-height:200px;overflow-y:auto;font-size:0.9rem;margin-top:1rem}.edit-item{padding:0.5rem;border-bottom:1px solid var(--border);font-size:0.85rem}.edit-item:last-child{border-bottom:none}
        @media(max-width:768px){.container{padding:1rem}h1{font-size:1.5rem}.setup-row{flex-direction:column}.input-group{width:100%}.step{padding:0.5rem 0.75rem;font-size:0.8rem}.main-play-btn{width:100px;height:100px}.main-play-btn svg{width:40px;height:40px}}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo"><div class="logo-icon"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg></div><h1>Oral Bridge</h1></div>
            <p class="subtitle">Hindi Team - AI-Assisted Bible Translation</p>
        </header>
        <div class="setup-section">
            <div class="setup-row">
                <div class="input-group"><label for="apiKey">Anthropic API Key</label><input type="password" id="apiKey" placeholder="sk-ant-..."></div>
                <div class="input-group"><label for="elevenLabsKey">ElevenLabs API Key</label><input type="password" id="elevenLabsKey" placeholder="For audio"></div>
                <div class="input-group" style="max-width:180px"><label for="modelSelect">Model</label><select id="modelSelect"><option value="claude-sonnet-4-20250514">Claude Sonnet 4</option><option value="claude-opus-4-5-20251101">Claude Opus 4.5</option></select></div>
            </div>
            <div class="setup-row" style="margin-top:1rem">
                <div class="input-group"><label for="biblicalRef">Biblical Reference</label><input type="text" id="biblicalRef" placeholder="e.g., Ruth 1:1-5"></div>
                <div class="input-group"><label for="targetLang">Target Language</label><select id="targetLang"><option value="hindi">Hindi (‡§¨‡•ã‡§≤‡§ö‡§æ‡§≤)</option><option value="english">English (Oral)</option><option value="portuguese_sertanejo">Portuguese (Sertanejo)</option><option value="spanish">Spanish (Coloquial)</option><option value="korean">Korean (Íµ¨Ïñ¥Ï≤¥)</option><option value="indonesian">Bahasa Indonesia</option></select></div>
                <div class="input-group"><label for="targetAudience">Target Audience</label><input type="text" id="targetAudience" placeholder="e.g., Rural farmers"></div>
            </div>
            <div class="button-row button-row-center" style="margin-top:1.5rem"><button class="btn btn-primary btn-large" onclick="startStep1()">‚ñ∂Ô∏è Start Translation</button></div>
        </div>
        <div id="progressSteps" class="progress-steps hidden">
            <div class="step" id="step1Ind" onclick="goToStep(1)"><span class="step-number">1</span><span>Map the Events</span></div>
            <div class="step" id="step2Ind" onclick="goToStep(2)"><span class="step-number">2</span><span>Map the Discourse</span></div>
            <div class="step" id="step3Ind" onclick="goToStep(3)"><span class="step-number">3</span><span>Review the Draft</span></div>
            <div class="step" id="step4Ind" onclick="goToStep(4)"><span class="step-number">4</span><span>Review the Performance</span></div>
        </div>
        <div id="workArea" class="main-card hidden"></div>
        <footer><p>Ready Vessels Project ‚Ä¢ Oral Bridge</p></footer>
    </div>
    <div id="voiceModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:2000;align-items:center;justify-content:center">
        <div style="background:white;padding:2rem;border-radius:12px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto">
            <h3 style="margin-bottom:1rem">üéôÔ∏è Configure Voice</h3>
            <div id="voiceConfigList"></div>
            <div class="button-row" style="justify-content:flex-end"><button class="btn btn-secondary" onclick="hideVoiceModal()">Cancel</button><button class="btn btn-primary" onclick="saveVoiceConfig()">Save</button></div>
        </div>
    </div>
    <div id="sendReportModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:2000;align-items:center;justify-content:center">
        <div style="background:white;padding:2rem;border-radius:12px;max-width:500px;width:90%">
            <h3 style="margin-bottom:1rem">üì§ Send to Reviewer</h3>
            <div class="input-group" style="margin-bottom:1rem"><label>Reviewer Email</label><input type="email" id="reviewerEmail" placeholder="reviewer@example.com" style="width:100%;padding:0.75rem;border:1px solid var(--border);border-radius:var(--radius)"></div>
            <div class="input-group" style="margin-bottom:1rem"><label>Your Notes (optional)</label><textarea id="reviewerNotes" rows="3" placeholder="Any notes for the reviewer..." style="width:100%;padding:0.75rem;border:1px solid var(--border);border-radius:var(--radius);font-family:inherit"></textarea></div>
            <div class="button-row" style="justify-content:flex-end"><button class="btn btn-secondary" onclick="hideSendModal()">Cancel</button><button class="btn btn-primary" onclick="sendToReviewer()">üìß Send Report</button></div>
        </div>
    </div>
<script>
let currentStep=0,outputs={},studio={text:'',firstDraft:'',editedDraft:'',segments:[],playingIdx:-1,isPlaying:false,analysis:null,editHistory:[],fullAudioUrl:null,approved:false},voiceConfig={};
const LANGS={hindi:{name:"Hindi (‡§¨‡•ã‡§≤‡§ö‡§æ‡§≤)",instruction:"‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§ï‡•Ä ‡§¨‡•ã‡§≤‡§ö‡§æ‡§≤ ‡§ï‡•Ä ‡§≠‡§æ‡§∑‡§æ ‡§Æ‡•á‡§Ç ‡§≤‡§ø‡§ñ‡•á‡§Ç‡•§ ‡§Æ‡•å‡§ñ‡§ø‡§ï ‡§ö‡§ø‡§π‡•ç‡§®‡§ï ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç‡•§",speechLang:'hi-IN'},english:{name:"English (Oral)",instruction:"Generate in natural, spoken English using oral storytelling register. Include oral markers: 'Now listen...', 'Then...'. Avoid formal Bible-speak.",speechLang:'en-US'},portuguese_sertanejo:{name:"Portuguese (Sertanejo)",instruction:"Gere em portugu√™s do Sert√£o Nordestino, registro oral. Use marcadores: 'Escuta s√≥...', 'A√≠...'.",speechLang:'pt-BR'},spanish:{name:"Spanish (Coloquial)",instruction:"Genera en espa√±ol coloquial hablado. Usa marcadores orales.",speechLang:'es-ES'},korean:{name:"Korean (Íµ¨Ïñ¥Ï≤¥)",instruction:"ÌïúÍµ≠Ïñ¥ Íµ¨Ïñ¥Ï≤¥Î°ú ÏÉùÏÑ±ÌïòÏÑ∏Ïöî. Íµ¨Ïà† ÌëúÏßÄÎ•º ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî.",speechLang:'ko-KR'},indonesian:{name:"Bahasa Indonesia",instruction:"Tulis dalam Bahasa Indonesia lisan sehari-hari.",speechLang:'id-ID'}};
const PROMPTS={1:`You are the Event Architect. Convert the biblical passage into a Meaning Map JSON with: meta, frames, participants, events. Use closed Event Cores, semantic roles, and modifiers. Return ONLY valid JSON.`,2:`You are the Discourse Weaver. Add discourse structure to the Meaning Map: functional_genre, literary_form, thematic_spine, peak_event_id, and for each event add discourse_function (SET/BG/MAIN/EVAL), peak flag, and discourse_logic relations. Return the enhanced JSON only.`,3:`You are the Oral Storyteller. Transform the Meaning Map into natural oral narrative.

=== FIDELITY CONSTRAINTS (ABSOLUTE) ===
You must preserve COMPLETE semantic fidelity to the Meaning Map:
‚Ä¢ INCLUDE every event, participant, and relationship in the map
‚Ä¢ PRESERVE all semantic roles (agent, patient, experiencer, etc.)
‚Ä¢ MAINTAIN temporal sequence and logical connections
‚Ä¢ NEVER add meanings, interpretations, or facts not in the map
‚Ä¢ NEVER omit any event or participant from the map
‚Ä¢ NEVER change who did what to whom

=== FORBIDDEN ADDITIONS ===
Do NOT add:
‚Ä¢ Character traits: "brave David", "wicked Pharaoh", "faithful Abraham"
‚Ä¢ Emotions not in map: "angrily said", "joyfully went", "sadly wept"  
‚Ä¢ Motivations: "because he was jealous", "wanting to help"
‚Ä¢ Evaluations: "this was wrong", "a great miracle", "an important moment"
‚Ä¢ Theological commentary: "as God had planned", "showing His mercy"
‚Ä¢ Explanations: "which means...", "in other words..."

=== PERMITTED ORAL FRAMING (Performance, not Content) ===
You MAY add ONLY these three types of navigational cues:

1. ATTENTIONAL MARKERS (phatic) - manage listener focus:
   ‚úì "Now listen..." / "Hear this..."
   ‚úó "Listen, for this is important..." (adds evaluation)

2. STRUCTURAL MARKERS (discursive) - signal transitions:
   ‚úì "That was the story of X. Now begins Y..."
   ‚úì "Some time later..." / "Meanwhile..."
   ‚úó "That was the amazing story of..." (adds evaluation)

3. TURN-TAKING MARKERS (deictic) - clarify speakers:
   ‚úì "Then Moses said..." / "The woman answered..."
   ‚úó "Then Moses, filled with courage, said..." (adds trait)

=== SUBTRACTION RULE ===
Test every addition: If removing it loses NO theological/narrative facts but only causes structural confusion, it is legitimate. If removing it loses information, it was an illegitimate addition.

=== OUTPUT ===
Generate natural oral narrative. Sound like spoken storytelling, not written text. Use the target language's oral register. Output ONLY the narrative.`};

const ANALYSIS_PROMPT=`You are a translation quality analyst. Analyze the draft translation against the Meaning Map for:

1. ACCURACY (1-5): Does it preserve all events, participants, and relationships from the Meaning Map?
2. NATURALNESS (1-5): Does it sound like natural spoken language, not written text?
3. INTELLIGIBILITY (1-5): Would the target audience easily understand this?
4. ORALNESS (1-5): Does it use appropriate oral markers, rhythm, and storytelling patterns?
5. STYLE/REGISTER (1-5): Is the register appropriate for oral Bible storytelling?

For each criterion, provide:
- Score (1-5)
- Brief explanation
- Specific recommendations for improvement (if any)

Also list any:
- Missing elements from the Meaning Map
- Unauthorized additions
- Awkward phrasings that need revision

Return as JSON:
{
  "scores": {
    "accuracy": {"score": N, "comment": "...", "recommendations": []},
    "naturalness": {"score": N, "comment": "...", "recommendations": []},
    "intelligibility": {"score": N, "comment": "...", "recommendations": []},
    "oralness": {"score": N, "comment": "...", "recommendations": []},
    "style": {"score": N, "comment": "...", "recommendations": []}
  },
  "missing_elements": [],
  "unauthorized_additions": [],
  "awkward_phrasings": [],
  "overall_score": N,
  "summary": "..."
}`;

const SEGMENT_COLORS=[{bg:'#bee3f8',color:'#2b6cb0'},{bg:'#c6f6d5',color:'#22543d'},{bg:'#fefcbf',color:'#744210'},{bg:'#fed7d7',color:'#c53030'},{bg:'#e9d8fd',color:'#553c9a'},{bg:'#b2f5ea',color:'#234e52'}];

function startStep1(){const apiKey=document.getElementById('apiKey').value,ref=document.getElementById('biblicalRef').value;if(!apiKey)return alert('Please enter your API key.');if(!ref)return alert('Please enter a biblical reference.');localStorage.setItem('anthropic_api_key',apiKey);const el=document.getElementById('elevenLabsKey');if(el.value)localStorage.setItem('elevenlabs_api_key',el.value);currentStep=1;document.getElementById('progressSteps').classList.remove('hidden');document.getElementById('workArea').classList.remove('hidden');updateProgress(1);showStep(1);runStep(1);}

function updateProgress(step){for(let i=1;i<=4;i++){const ind=document.getElementById('step'+i+'Ind');ind.classList.remove('active','completed');if(i<step&&outputs[i])ind.classList.add('completed');else if(i===step)ind.classList.add('active');}}

function showStep(step){const workArea=document.getElementById('workArea'),ref=document.getElementById('biblicalRef').value,lang=document.getElementById('targetLang').value,langName=LANGS[lang]?.name||lang;
if(step===1){workArea.innerHTML='<div class="card-header step-1"><div class="step-badge">1</div><div class="card-title"><h2>Map the Events</h2><p>'+ref+'</p></div></div><div class="card-body"><div id="output1">'+(outputs[1]?'<div class="message message-success">‚úì Step 1 complete</div><label class="text-label">Result:</label><textarea class="text-box json-output" rows="6" readonly>'+outputs[1]+'</textarea><div class="button-row"><button class="btn btn-secondary" onclick="navigator.clipboard.writeText(outputs[1]).then(()=>alert(\'Copied!\'))">üìã Copy</button><button class="btn btn-primary btn-large" onclick="goToStep(2)">‚ñ∂Ô∏è Continue to Step 2</button></div>':'')+'</div></div>';}
else if(step===2){workArea.innerHTML='<div class="card-header step-2"><div class="step-badge">2</div><div class="card-title"><h2>Map the Discourse</h2><p>Narrative flow</p></div></div><div class="card-body"><textarea class="text-box json-output" id="input2" rows="4" style="display:none">'+(outputs[1]||'')+'</textarea><div id="output2">'+(outputs[2]?'<div class="message message-success">‚úì Step 2 complete</div><label class="text-label">Result:</label><textarea class="text-box json-output" rows="6" readonly>'+outputs[2]+'</textarea><div class="button-row"><button class="btn btn-secondary" onclick="goToStep(1)">‚Üê Back</button><button class="btn btn-secondary" onclick="navigator.clipboard.writeText(outputs[2]).then(()=>alert(\'Copied!\'))">üìã Copy</button><button class="btn btn-primary btn-large" onclick="goToStep(3)">‚ñ∂Ô∏è Continue to Step 3</button></div>':'')+'</div></div>';}
else if(step===3){workArea.innerHTML=buildStep3UI();}
else if(step===4){workArea.innerHTML=buildStep4UI();initStep4();}}

function buildStep3UI(){const langName=LANGS[document.getElementById('targetLang').value]?.name||'Target Language';
let html='<div class="card-header step-3"><div class="step-badge">3</div><div class="card-title"><h2>Review the Draft</h2><p>'+langName+'</p></div></div><div class="card-body">';
html+='<textarea class="text-box json-output" id="input3" rows="4" style="display:none">'+(outputs[2]||'')+'</textarea>';
html+='<div id="step3Content">';
if(!studio.firstDraft){html+='<div class="button-row button-row-center"><button class="btn btn-primary btn-large" onclick="generateAndAnalyzeDraft()">ü§ñ Generate Draft</button></div>';}
else{
html+='<div class="message message-success">‚úì Draft generated</div>';
html+='<label class="text-label">Generated Draft (read-only):</label>';
html+='<textarea class="text-box output" rows="6" readonly>'+escapeHtml(studio.firstDraft)+'</textarea>';
if(studio.analysis){
html+='<div class="analysis-section"><h3 style="color:#166534;margin-bottom:1rem">üìä Quality Analysis</h3>';
html+=renderAnalysis(studio.analysis);
html+='</div>';
}
html+='<div class="edit-section"><h3 style="color:var(--accent);margin-bottom:1rem">‚úèÔ∏è Edit the Draft</h3>';
html+='<p style="margin-bottom:1rem;color:var(--text-secondary)">Review the analysis above and make any necessary changes to the draft below:</p>';
html+='<textarea class="text-box editable" id="editableDraft" rows="8">'+escapeHtml(studio.editedDraft||studio.firstDraft)+'</textarea>';
if(studio.editHistory.length>0){
html+='<div class="edit-history"><strong>Edit History:</strong>';
studio.editHistory.forEach((e,i)=>{html+='<div class="edit-item">'+new Date(e.timestamp).toLocaleTimeString()+': Saved edit #'+(i+1)+'</div>';});
html+='</div>';}
html+='<div class="button-row"><button class="btn btn-secondary" onclick="goToStep(2)">‚Üê Back to Step 2</button><button class="btn btn-secondary" onclick="saveDraftEdits()">üíæ Save Edits</button><button class="btn btn-success btn-large" onclick="saveDraftEdits();goToStep(4)">üîä Continue to Performance ‚Üí</button></div>';
html+='</div>';}
html+='</div></div>';
return html;}

function renderAnalysis(analysis){let html='<div style="display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:1rem">';
const criteria=['accuracy','naturalness','intelligibility','oralness','style'];
criteria.forEach(c=>{const s=analysis.scores[c];const scoreClass=s.score>=4?'score-good':s.score>=3?'score-ok':'score-low';
html+='<span class="analysis-score '+scoreClass+'">'+c.charAt(0).toUpperCase()+c.slice(1)+': '+s.score+'/5</span>';});
html+='<span class="analysis-score '+(analysis.overall_score>=4?'score-good':analysis.overall_score>=3?'score-ok':'score-low')+'">Overall: '+analysis.overall_score+'/5</span></div>';
html+='<p style="margin-bottom:1rem;font-style:italic">'+escapeHtml(analysis.summary)+'</p>';
criteria.forEach(c=>{const s=analysis.scores[c];if(s.recommendations&&s.recommendations.length>0){
html+='<div class="analysis-item'+(s.score<3?' issue':s.score<4?' warning':'')+'"><strong>'+c.charAt(0).toUpperCase()+c.slice(1)+':</strong> '+escapeHtml(s.comment);
html+='<ul style="margin:0.5rem 0 0 1.5rem">';s.recommendations.forEach(r=>{html+='<li>'+escapeHtml(r)+'</li>';});html+='</ul></div>';}});
if(analysis.missing_elements&&analysis.missing_elements.length>0){html+='<div class="analysis-item issue"><strong>‚ö†Ô∏è Missing Elements:</strong><ul style="margin:0.5rem 0 0 1.5rem">';analysis.missing_elements.forEach(m=>{html+='<li>'+escapeHtml(m)+'</li>';});html+='</ul></div>';}
if(analysis.unauthorized_additions&&analysis.unauthorized_additions.length>0){html+='<div class="analysis-item issue"><strong>‚ö†Ô∏è Unauthorized Additions:</strong><ul style="margin:0.5rem 0 0 1.5rem">';analysis.unauthorized_additions.forEach(a=>{html+='<li>'+escapeHtml(a)+'</li>';});html+='</ul></div>';}
if(analysis.awkward_phrasings&&analysis.awkward_phrasings.length>0){html+='<div class="analysis-item warning"><strong>üìù Awkward Phrasings:</strong><ul style="margin:0.5rem 0 0 1.5rem">';analysis.awkward_phrasings.forEach(p=>{html+='<li>'+escapeHtml(p)+'</li>';});html+='</ul></div>';}
return html;}

async function generateAndAnalyzeDraft(){const apiKey=document.getElementById('apiKey').value||localStorage.getItem('anthropic_api_key'),model=document.getElementById('modelSelect').value,lang=document.getElementById('targetLang').value,aud=document.getElementById('targetAudience').value;
const content=document.getElementById('step3Content');
content.innerHTML='<div class="loading"><div class="spinner"></div><div class="loading-text">Generating draft...</div></div>';
try{
const msg='Target: '+(LANGS[lang]?.name||lang)+'\nAudience: '+aud+'\nInstruction: '+(LANGS[lang]?.instruction||'')+'\n\n'+(outputs[2]||outputs[1]);
const resp=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':apiKey,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:model,max_tokens:8192,system:PROMPTS[3],messages:[{role:'user',content:msg}]})});
if(!resp.ok)throw new Error('API error');
const data=await resp.json();
studio.firstDraft=data.content?.[0]?.text||'';
studio.editedDraft=studio.firstDraft;
outputs[3]=studio.firstDraft;
content.innerHTML='<div class="loading"><div class="spinner"></div><div class="loading-text">Analyzing quality...</div></div>';
const analysisResp=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':apiKey,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:model,max_tokens:4000,system:ANALYSIS_PROMPT,messages:[{role:'user',content:'MEANING MAP:\n'+(outputs[2]||outputs[1])+'\n\nDRAFT TRANSLATION:\n'+studio.firstDraft}]})});
if(analysisResp.ok){const analysisData=await analysisResp.json();const analysisText=analysisData.content?.[0]?.text||'';const match=analysisText.match(/\{[\s\S]*\}/);if(match){try{studio.analysis=JSON.parse(match[0]);}catch(e){console.error('Analysis parse error',e);}}}
updateProgress(4);
showStep(3);
}catch(e){content.innerHTML='<div class="message message-error">Error: '+e.message+'</div><div class="button-row"><button class="btn btn-primary" onclick="generateAndAnalyzeDraft()">Retry</button></div>';}}

function saveDraftEdits(){const textarea=document.getElementById('editableDraft');if(textarea){const newText=textarea.value;if(newText!==studio.editedDraft){studio.editHistory.push({timestamp:new Date().toISOString(),previous:studio.editedDraft,current:newText});studio.editedDraft=newText;outputs[3]=newText;}}}

function buildStep4UI(){const langName=LANGS[document.getElementById('targetLang').value]?.name||'Target Language';
let html='<div class="card-header step-4"><div class="step-badge">4</div><div class="card-title"><h2>Review the Performance</h2><p>'+langName+'</p></div></div><div class="card-body">';
html+='<div style="background:#f0fff4;border:1px solid #9ae6b4;border-radius:var(--radius-lg);padding:1.5rem;margin-bottom:1.5rem">';
html+='<div style="display:flex;gap:1rem;align-items:center;flex-wrap:wrap;justify-content:center">';
html+='<select id="studioLang" style="padding:0.75rem;border:2px solid #9ae6b4;border-radius:var(--radius);min-width:200px">'+Object.entries(LANGS).map(([k,v])=>'<option value="'+k+'"'+(k===document.getElementById('targetLang').value?' selected':'')+'>'+v.name+'</option>').join('')+'</select>';
html+='<button class="btn btn-secondary" onclick="showVoiceModal()">‚öôÔ∏è Select the Voice</button>';
html+='<button class="btn btn-success btn-large" onclick="generatePerformance()">üîä Generate the Oral Performance</button>';
html+='</div></div>';
html+='<div id="audioPanel" class="validator-audio-panel" style="display:none">';
html+='<h3 style="color:var(--validator-primary);margin-bottom:1rem">üîä Oral Performance</h3>';
html+='<div id="segmentNav" class="segment-nav"><div style="flex:1;display:flex;align-items:center;justify-content:center;color:#666">Loading...</div></div>';
html+='<button id="mainPlayBtn" class="main-play-btn" onclick="toggleMainPlay()"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>';
html+='<div class="time-display"><span id="currentTime">0:00</span> / <span id="totalTime">0:00</span></div>';
html+='<div class="audio-progress" onclick="seekAudio(event)"><div id="progressFill" class="audio-progress-fill"></div></div>';
html+='<div style="display:flex;gap:0.75rem;justify-content:center;margin-top:1rem">';
html+='<button class="btn btn-secondary btn-small" onclick="skipSegment(-1)">‚èÆÔ∏è</button>';
html+='<button class="btn btn-secondary btn-small" onclick="restartAudio()">üîÑ</button>';
html+='<button class="btn btn-secondary btn-small" onclick="skipSegment(1)">‚è≠Ô∏è</button>';
html+='</div>';
html+='<div id="audioStatus" style="margin-top:1rem;font-size:0.9rem;color:var(--text-secondary)"></div>';
html+='<audio id="audioPlayer" style="display:none"></audio>';
html+='</div>';
html+='<div class="message message-info" style="margin-top:1.5rem"><strong>üí° Need to make changes?</strong> Go back to Step 3 to edit the text, then return here to generate a new performance.</div>';
html+='<div class="button-row"><button class="btn btn-secondary" onclick="goToStep(3)">‚Üê Back to Edit Draft</button></div>';
html+='<div id="approvalSection" style="display:none;margin-top:1.5rem;padding:1.5rem;background:linear-gradient(135deg,#c6f6d5,#9ae6b4);border:2px solid #38a169;border-radius:var(--radius-lg)">';
html+='<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem">';
html+='<h4 style="color:#276749">‚úÖ Approve Translation</h4>';
html+='<button id="approveBtn" class="btn btn-success btn-large" onclick="toggleApproval()">‚òê Approve</button>';
html+='</div></div>';
html+='<div id="sessionSummarySection" style="display:none;margin-top:1.5rem;padding:1.5rem;background:linear-gradient(135deg,#FEF3C7,#FDE68A);border:2px solid #F59E0B;border-radius:var(--radius-lg)">';
html+='<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;margin-bottom:1rem">';
html+='<h3 style="color:#92400E">üì¶ Session Complete</h3>';
html+='<div style="display:flex;gap:0.75rem;flex-wrap:wrap">';
html+='<button class="btn btn-primary" onclick="downloadSessionSummary()">üìÑ Download Summary</button>';
html+='<button class="btn btn-secondary" onclick="downloadAudioFile()">üîä Download Audio</button>';
html+='<button class="btn btn-success" onclick="showSendModal()">üì§ Send to Reviewer</button>';
html+='</div></div>';
html+='<p style="color:#92400E;font-size:0.95rem">Your work is complete. Download your files or send the session report to a reviewer for feedback.</p>';
html+='</div>';
html+='</div>';
return html;}

function initStep4(){studio.text=studio.editedDraft||studio.firstDraft||outputs[3]||'';if(studio.fullAudioUrl){document.getElementById('audioPanel').style.display='block';document.getElementById('approvalSection').style.display='block';segmentText();}}

async function generatePerformance(){studio.text=studio.editedDraft||studio.firstDraft||outputs[3]||'';if(!studio.text){alert('No draft text available. Go back to Step 3.');return;}
const key=document.getElementById('elevenLabsKey').value||localStorage.getItem('elevenlabs_api_key');if(!key){alert('Please enter your ElevenLabs API key.');return;}
const langKey=document.getElementById('studioLang').value;loadVoiceConfig();const voiceId=voiceConfig[langKey];if(!voiceId){alert('Please configure a voice for '+LANGS[langKey].name+' first.');showVoiceModal();return;}
document.getElementById('audioPanel').style.display='block';document.getElementById('audioStatus').textContent='‚è≥ Generating audio...';segmentText();
try{const resp=await fetch('https://api.elevenlabs.io/v1/text-to-speech/'+voiceId,{method:'POST',headers:{'Accept':'audio/mpeg','Content-Type':'application/json','xi-api-key':key},body:JSON.stringify({text:studio.text,model_id:'eleven_multilingual_v2',voice_settings:{stability:0.5,similarity_boost:0.75}})});
if(!resp.ok)throw new Error('ElevenLabs error');
const blob=await resp.blob();studio.fullAudioUrl=URL.createObjectURL(blob);
const player=document.getElementById('audioPlayer');player.src=studio.fullAudioUrl;
player.onloadedmetadata=()=>{calcSegmentTimings(player.duration);document.getElementById('totalTime').textContent=formatTime(player.duration);setupPlayerEvents();document.getElementById('audioStatus').textContent='‚úÖ Ready!';document.getElementById('approvalSection').style.display='block';};
}catch(e){document.getElementById('audioStatus').textContent='‚ùå Error: '+e.message;}}

function segmentText(){const text=studio.text,parts=text.split(/(?<=[.!?:;])\s+/).filter(s=>s.trim());studio.segments=[];let buf='';for(let i=0;i<parts.length;i++){buf+=(buf?' ':'')+parts[i].trim();if(buf.length>=50||i===parts.length-1){studio.segments.push({id:studio.segments.length,text:buf.trim()});buf='';}}if(!studio.segments.length)studio.segments=[{id:0,text:text.trim()}];renderSegmentNav();}

function renderSegmentNav(){const nav=document.getElementById('segmentNav');if(!nav)return;if(!studio.segments.length){nav.innerHTML='<div style="flex:1;display:flex;align-items:center;justify-content:center;color:#666">No segments</div>';return;}const total=studio.segments.reduce((s,seg)=>s+seg.text.length,0);nav.innerHTML=studio.segments.map((seg,i)=>{const w=(seg.text.length/total)*100,c=SEGMENT_COLORS[i%SEGMENT_COLORS.length];return '<div class="segment-block '+(i===studio.playingIdx?'playing':'')+'" style="flex:0 0 '+w+'%;background:'+c.bg+';color:'+c.color+'" title="'+escapeHtml(seg.text.substring(0,50))+'...">'+(i+1)+'</div>';}).join('');}

function calcSegmentTimings(duration){const total=studio.segments.reduce((s,seg)=>s+seg.text.length,0);let t=0;studio.segments.forEach(seg=>{const dur=duration*(seg.text.length/total);seg.start=t;seg.end=t+dur;t+=dur;});}

function setupPlayerEvents(){const player=document.getElementById('audioPlayer');player.ontimeupdate=()=>{document.getElementById('progressFill').style.width=(player.currentTime/player.duration)*100+'%';document.getElementById('currentTime').textContent=formatTime(player.currentTime);const idx=studio.segments.findIndex(s=>player.currentTime>=s.start&&player.currentTime<s.end);if(idx!==studio.playingIdx){studio.playingIdx=idx;renderSegmentNav();}};player.onplay=()=>{studio.isPlaying=true;updatePlayButton();};player.onpause=()=>{studio.isPlaying=false;updatePlayButton();};player.onended=()=>{studio.isPlaying=false;studio.playingIdx=-1;updatePlayButton();renderSegmentNav();};}

function updatePlayButton(){const btn=document.getElementById('mainPlayBtn');if(!btn)return;if(studio.isPlaying){btn.classList.add('playing');btn.innerHTML='<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';}else{btn.classList.remove('playing');btn.innerHTML='<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';}}

function formatTime(s){if(isNaN(s))return'0:00';return Math.floor(s/60)+':'+String(Math.floor(s%60)).padStart(2,'0');}
function toggleMainPlay(){const player=document.getElementById('audioPlayer');if(!player.src){document.getElementById('audioStatus').textContent='‚ö†Ô∏è Generate audio first';return;}if(studio.isPlaying)player.pause();else player.play();}
function restartAudio(){const player=document.getElementById('audioPlayer');player.currentTime=0;player.play();}
function seekAudio(e){const player=document.getElementById('audioPlayer'),rect=e.target.getBoundingClientRect();player.currentTime=((e.clientX-rect.left)/rect.width)*player.duration;}
function skipSegment(delta){const current=studio.playingIdx>=0?studio.playingIdx:0,next=Math.max(0,Math.min(studio.segments.length-1,current+delta));if(studio.segments[next]){const player=document.getElementById('audioPlayer');player.currentTime=studio.segments[next].start;player.play();}}

function toggleApproval(){studio.approved=!studio.approved;document.getElementById('approveBtn').innerHTML=studio.approved?'‚úÖ Approved':'‚òê Approve';document.getElementById('sessionSummarySection').style.display=studio.approved?'block':'none';}

async function runStep(step){const apiKey=document.getElementById('apiKey').value||localStorage.getItem('anthropic_api_key'),model=document.getElementById('modelSelect').value,ref=document.getElementById('biblicalRef').value,out=document.getElementById('output'+step);out.innerHTML='<div class="loading"><div class="spinner"></div><div class="loading-text">Processing...</div></div>';let msg='';if(step===1)msg='Biblical Reference: '+ref+'\n\nCreate the Meaning Map JSON.';else if(step===2)msg=document.getElementById('input2').value;
try{const resp=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':apiKey,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:model,max_tokens:8192,system:PROMPTS[step],messages:[{role:'user',content:msg}]})});if(!resp.ok)throw new Error('API error');const data=await resp.json(),result=data.content?.[0]?.text||'';outputs[step]=result;currentStep=step;updateProgress(step+1);
let nextBtn='';if(step===1)nextBtn='<button class="btn btn-primary btn-large" onclick="goToStep(2);runStep(2)">‚ñ∂Ô∏è Map the Discourse</button>';else if(step===2)nextBtn='<button class="btn btn-primary btn-large" onclick="goToStep(3)">‚ñ∂Ô∏è Review the Draft</button>';
out.innerHTML='<div class="message message-success">‚úì Step '+step+' complete</div><label class="text-label">Result:</label><textarea class="text-box json-output" rows="6" readonly>'+result+'</textarea><div class="button-row">'+(step>1?'<button class="btn btn-secondary" onclick="goToStep('+(step-1)+')">‚Üê Back</button>':'')+'<button class="btn btn-secondary" onclick="navigator.clipboard.writeText(outputs['+step+']).then(()=>alert(\'Copied!\'))">üìã Copy</button>'+nextBtn+'</div>';}catch(e){out.innerHTML='<div class="message message-error">Error: '+e.message+'</div><div class="button-row"><button class="btn btn-primary" onclick="runStep('+step+')">Retry</button></div>';}}

function goToStep(step){if(step===3&&document.getElementById('editableDraft')){saveDraftEdits();}currentStep=step;updateProgress(step);showStep(step);window.scrollTo({top:0,behavior:'smooth'});}

function showVoiceModal(){document.getElementById('voiceModal').style.display='flex';loadVoiceConfig();document.getElementById('voiceConfigList').innerHTML=Object.entries(LANGS).map(([k,v])=>'<div style="margin-bottom:1rem"><label style="font-weight:600">'+v.name+'</label><input type="text" class="voice-input" data-lang="'+k+'" value="'+(voiceConfig[k]||'')+'" placeholder="ElevenLabs Voice ID" style="width:100%;padding:0.5rem;margin-top:0.25rem;border:1px solid var(--border);border-radius:var(--radius)"></div>').join('')+'<p style="font-size:0.85em;color:#666">Get Voice IDs from <a href="https://elevenlabs.io" target="_blank">ElevenLabs</a></p>';}
function hideVoiceModal(){document.getElementById('voiceModal').style.display='none';}
function loadVoiceConfig(){const s=localStorage.getItem('voice_config');if(s)voiceConfig=JSON.parse(s);}
function saveVoiceConfig(){document.querySelectorAll('.voice-input').forEach(inp=>{if(inp.value.trim())voiceConfig[inp.dataset.lang]=inp.value.trim();else delete voiceConfig[inp.dataset.lang];});localStorage.setItem('voice_config',JSON.stringify(voiceConfig));hideVoiceModal();alert('Saved!');}

function showSendModal(){document.getElementById('sendReportModal').style.display='flex';}
function hideSendModal(){document.getElementById('sendReportModal').style.display='none';}
function sendToReviewer(){const email=document.getElementById('reviewerEmail').value;if(!email){alert('Please enter reviewer email.');return;}const notes=document.getElementById('reviewerNotes').value;const summary=generateSummaryHTML(notes,email);const blob=new Blob([summary],{type:'text/html'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href='mailto:'+email+'?subject=Translation Review Request: '+encodeURIComponent(document.getElementById('biblicalRef').value)+'&body='+encodeURIComponent('Please find the attached session report for review.\n\nNotes: '+(notes||'None')+'\n\nThe full HTML report is attached separately.');a.click();downloadSessionSummary();hideSendModal();alert('Email client opened and report downloaded. Please attach the downloaded HTML file to your email.');}

function generateSummaryHTML(notes,reviewer){const ref=document.getElementById('biblicalRef').value||'Unknown Reference';const lang=LANGS[document.getElementById('targetLang').value]?.name||'Unknown';const aud=document.getElementById('targetAudience').value||'General';const now=new Date().toLocaleString();
return `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Session Report - ${escapeHtml(ref)}</title>
<style>
body{font-family:'Segoe UI',system-ui,sans-serif;max-width:900px;margin:0 auto;padding:2rem;line-height:1.7;color:#1a1a1a;background:#faf9f7}
h1{color:#92400E;border-bottom:3px solid #F59E0B;padding-bottom:0.5rem}
h2{color:#1e40af;margin-top:2rem;border-left:4px solid #3b82f6;padding-left:1rem}
h3{color:#166534;margin-top:1.5rem}
.meta{background:#f3f4f6;padding:1rem;border-radius:8px;margin-bottom:2rem}
.meta-item{margin:0.5rem 0}
.meta-label{font-weight:600;color:#4b5563}
.section{background:white;border:1px solid #e5e7eb;border-radius:8px;padding:1.5rem;margin:1rem 0}
.json-block{background:#1f2937;color:#e5e7eb;padding:1rem;border-radius:8px;overflow-x:auto;font-family:monospace;font-size:0.85rem;white-space:pre-wrap;max-height:400px;overflow-y:auto}
.text-block{background:#f0fdf4;border:1px solid #86efac;padding:1rem;border-radius:8px;font-size:1.05rem}
.analysis-block{background:#ebf8ff;border:1px solid #90cdf4;padding:1rem;border-radius:8px;margin:1rem 0}
.score-badge{display:inline-block;padding:0.25rem 0.5rem;border-radius:4px;font-weight:600;font-size:0.85rem;margin-right:0.5rem}
.score-good{background:#c6f6d5;color:#166534}
.score-ok{background:#fef3c7;color:#92400e}
.score-low{background:#fecaca;color:#991b1b}
.edit-item{background:#fef3c7;border-left:4px solid #f59e0b;padding:0.75rem 1rem;margin:0.5rem 0;border-radius:0 8px 8px 0}
.reviewer-notes{background:#e0e7ff;border:2px solid #818cf8;padding:1rem;border-radius:8px;margin:1rem 0}
footer{margin-top:3rem;padding-top:1rem;border-top:1px solid #e5e7eb;color:#6b7280;font-size:0.85rem;text-align:center}
</style>
</head>
<body>
<h1>üìã Translation Session Report</h1>

<div class="meta">
<div class="meta-item"><span class="meta-label">Biblical Reference:</span> ${escapeHtml(ref)}</div>
<div class="meta-item"><span class="meta-label">Target Language:</span> ${escapeHtml(lang)}</div>
<div class="meta-item"><span class="meta-label">Target Audience:</span> ${escapeHtml(aud)}</div>
<div class="meta-item"><span class="meta-label">Session Date:</span> ${now}</div>
<div class="meta-item"><span class="meta-label">Status:</span> <span style="background:#c6f6d5;color:#166534;padding:0.25rem 0.75rem;border-radius:20px;font-weight:600">‚úÖ Approved</span></div>
${reviewer?'<div class="meta-item"><span class="meta-label">Sent to:</span> '+escapeHtml(reviewer)+'</div>':''}
</div>

${notes?'<div class="reviewer-notes"><strong>üìù Notes for Reviewer:</strong><p>'+escapeHtml(notes)+'</p></div>':''}

<h2>1. Meaning Map (Events)</h2>
<div class="section">
<div class="json-block">${escapeHtml(outputs[1]||'Not generated')}</div>
</div>

<h2>2. Discourse Structure</h2>
<div class="section">
<div class="json-block">${escapeHtml(outputs[2]||'Not generated')}</div>
</div>

<h2>3. Translation Draft</h2>
<div class="section">
<h3>AI-Generated Draft</h3>
<div class="text-block">${escapeHtml(studio.firstDraft)||'<em>Not generated</em>'}</div>

${studio.analysis?`<h3>Quality Analysis</h3>
<div class="analysis-block">
<div style="margin-bottom:1rem">
<span class="score-badge ${studio.analysis.scores.accuracy.score>=4?'score-good':studio.analysis.scores.accuracy.score>=3?'score-ok':'score-low'}">Accuracy: ${studio.analysis.scores.accuracy.score}/5</span>
<span class="score-badge ${studio.analysis.scores.naturalness.score>=4?'score-good':studio.analysis.scores.naturalness.score>=3?'score-ok':'score-low'}">Naturalness: ${studio.analysis.scores.naturalness.score}/5</span>
<span class="score-badge ${studio.analysis.scores.intelligibility.score>=4?'score-good':studio.analysis.scores.intelligibility.score>=3?'score-ok':'score-low'}">Intelligibility: ${studio.analysis.scores.intelligibility.score}/5</span>
<span class="score-badge ${studio.analysis.scores.oralness.score>=4?'score-good':studio.analysis.scores.oralness.score>=3?'score-ok':'score-low'}">Oralness: ${studio.analysis.scores.oralness.score}/5</span>
<span class="score-badge ${studio.analysis.scores.style.score>=4?'score-good':studio.analysis.scores.style.score>=3?'score-ok':'score-low'}">Style: ${studio.analysis.scores.style.score}/5</span>
<span class="score-badge ${studio.analysis.overall_score>=4?'score-good':studio.analysis.overall_score>=3?'score-ok':'score-low'}"><strong>Overall: ${studio.analysis.overall_score}/5</strong></span>
</div>
<p><strong>Summary:</strong> ${escapeHtml(studio.analysis.summary)}</p>
</div>`:''}

${studio.editedDraft&&studio.editedDraft!==studio.firstDraft?`<h3>Edited Draft (Final)</h3>
<div class="text-block" style="background:#dcfce7;border-color:#22c55e">${escapeHtml(studio.editedDraft)}</div>`:'<p><em>No manual edits were made to the draft.</em></p>'}

${studio.editHistory.length>0?`<h3>Edit History</h3>
${studio.editHistory.map((e,i)=>'<div class="edit-item"><strong>Edit #'+(i+1)+'</strong> - '+new Date(e.timestamp).toLocaleString()+'</div>').join('')}`:''}
</div>

<h2>4. Final Approved Text</h2>
<div class="section">
<div class="text-block" style="background:#dcfce7;border-color:#22c55e;font-size:1.1rem">${escapeHtml(studio.editedDraft||studio.firstDraft)||'<em>Not available</em>'}</div>
</div>

<h2>5. Audio Performance</h2>
<div class="section">
<p><strong>Status:</strong> ${studio.fullAudioUrl?'‚úÖ Audio generated and approved':'‚è≥ No audio generated'}</p>
<p><em>The audio file should be downloaded separately using the app.</em></p>
</div>

<footer>
<p>Generated by Oral Bridge - Hindi Team</p>
<p>Ready Vessels Project</p>
</footer>
</body>
</html>`;}

function downloadSessionSummary(){const html=generateSummaryHTML();const blob=new Blob([html],{type:'text/html'});const url=URL.createObjectURL(blob);const a=document.createElement('a');const ref=document.getElementById('biblicalRef').value||'session';a.href=url;a.download='session_report_'+ref.replace(/[^a-z0-9]/gi,'_')+'_'+new Date().toISOString().slice(0,10)+'.html';a.click();URL.revokeObjectURL(url);}

function downloadAudioFile(){if(!studio.fullAudioUrl){alert('No audio file available. Generate the oral performance first.');return;}const ref=document.getElementById('biblicalRef').value||'audio';const a=document.createElement('a');a.href=studio.fullAudioUrl;a.download='oral_performance_'+ref.replace(/[^a-z0-9]/gi,'_')+'_'+new Date().toISOString().slice(0,10)+'.mp3';a.click();}

function escapeHtml(text){if(!text)return'';return String(text).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');}

document.addEventListener('DOMContentLoaded',()=>{const k1=localStorage.getItem('anthropic_api_key'),k2=localStorage.getItem('elevenlabs_api_key');if(k1)document.getElementById('apiKey').value=k1;if(k2)document.getElementById('elevenLabsKey').value=k2;loadVoiceConfig();});
</script>
</body>
</html>
